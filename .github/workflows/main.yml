name: Build KataGo for ARM (Ubuntu)

on:
  workflow_dispatch:
  push:
    branches: [ main ]
  pull_request:

jobs:
  build-katago:
    runs-on: ubuntu-latest
    env:
      BUILD_THREADS: 4
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v2
    
    - name: Set up ARM build environment
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          git cmake build-essential \
          gcc-arm-linux-gnueabihf g++-arm-linux-gnueabihf \
          libzip-dev libboost-dev libboost-filesystem-dev \
          libboost-system-dev libopenblas-dev libeigen3-dev \
          pkg-config
        
    - name: Clone KataGo source with correct toolchain
      run: |
        git clone --depth 1 --branch master --recursive https://github.com/lightvector/KataGo.git
        mkdir -p KataGo/toolchains
        
        # Use correct toolchain URL from KataGo's repo
        if [ -f KataGo/toolchains/arm-linux-gnueabihf.cmake ]; then
          echo "Toolchain exists in cloned repo"
        else
          echo "::warning::Toolchain not in repo, trying alternative source..."
          curl -sSfL -o KataGo/toolchains/arm-linux-gnueabihf.cmake \
            https://raw.githubusercontent.com/lightvector/KataGo/v1.12.2/toolchains/arm-linux-gnueabihf.cmake || \
          curl -sSfL -o KataGo/toolchains/arm-linux-gnueabihf.cmake \
            https://raw.githubusercontent.com/lightvector/KataGo/latest/toolchains/arm-linux-gnueabihf.cmake
        fi
        
        # Final verification
        if [ ! -f KataGo/toolchains/arm-linux-gnueabihf.cmake ]; then
          echo "::error::Could not obtain toolchain file!"
          exit 1
        fi
        echo "Toolchain file content:"
        head -n 10 KataGo/toolchains/arm-linux-gnueabihf.cmake
        
    - name: Configure for ARM
      run: |
        cd KataGo/cpp
        cmake . \
          -DUSE_BACKEND=EIGEN \
          -DNO_GIT_REVISION=1 \
          -DCMAKE_TOOLCHAIN_FILE="../../toolchains/arm-linux-gnueabihf.cmake" \
          -DCMAKE_C_COMPILER=arm-linux-gnueabihf-gcc \
          -DCMAKE_CXX_COMPILER=arm-linux-gnueabihf-g++ \
          -DCMAKE_BUILD_TYPE=Release
        
    - name: Build KataGo
      run: |
        cd KataGo/cpp
        make -j$BUILD_THREADS VERBOSE=1
        arm-linux-gnueabihf-strip katago
        
    - name: Verify binary
      id: verify
      run: |
        if [ -f KataGo/cpp/katago ]; then
          echo "::set-output name=status::success"
          echo "=== Binary Info ==="
          file KataGo/cpp/katago
        else
          echo "::set-output name=status::failure"
          echo "::error::Binary not found after build!"
          exit 1
        fi
        
    - name: Package artifact
      if: steps.verify.outputs.status == 'success'
      run: |
        mkdir -p artifact
        cp KataGo/cpp/katago artifact/
        tar czvf katago-arm-bin.tar.gz -C artifact .
        
    - name: Success notification
      if: steps.verify.outputs.status == 'success'
      run: |
        echo "::notice title=Build Success::KataGo ARM build completed"
        echo "Binary size: $(du -h KataGo/cpp/katago | cut -f1)"
